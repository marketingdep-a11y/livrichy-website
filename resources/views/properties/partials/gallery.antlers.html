<div
    x-cloak
    x-data="{
        open: false,
        activeSlide: 0,
        slides: [],
        openAt(index) { this.activeSlide = index; this.open = true; },
        handleImageError(event) {
            const failedSrc = event.target.src;
            const failedIndex = this.slides.indexOf(failedSrc);
            
            // Try next image if available
            if (this.slides && failedIndex >= 0 && failedIndex < this.slides.length - 1) {
                const nextIndex = failedIndex + 1;
                if (this.slides[nextIndex] && event.target.src !== this.slides[nextIndex]) {
                    event.target.src = this.slides[nextIndex];
                    return;
                }
            }
            
            // If no next image or all failed, show placeholder
            event.target.onerror = null;
            event.target.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'600\'%3E%3Crect fill=\'%23ddd\' width=\'800\' height=\'600\'/%3E%3Ctext fill=\'%23999\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' font-size=\'24\'%3EImage not available%3C/text%3E%3C/svg%3E';
        },
        initSlides() {
            const slides = [];
            
            // First: featured_image (Glide, works) or photo_links fallback
            {{ if featured_image }}
                const featuredImg = '{{ glide:featured_image preset='xl' }}';
                if (featuredImg && featuredImg.trim()) {
                    slides.push(featuredImg);
                } else {
                    {{ asset :url="featured_image" }}
                        slides.push('{{ url }}');
                    {{ /asset }}
                }
            {{ elseif photo_links | first }}
                slides.push('{{ photo_links | first }}');
            {{ /if }}
            
            // Second: gallery images (Glide, works) or photo_links as fallback
            {{ gallery }}slides.push('{{ glide:url preset='xl' }}');{{ /gallery }}
            
            // Third: photo_links fallback - use if gallery is empty or as additional images
            {{ if featured_image && !gallery }}
                {{ if photo_links | first }}slides.push('{{ photo_links | first }}');{{ /if }}
            {{ elseif !featured_image && !gallery }}
                {{ photo_links }}slides.push('{{ value }}');{{ /photo_links }}
            {{ elseif !featured_image && gallery }}
                {{ if photo_links | first }}slides.push('{{ photo_links | first }}');{{ /if }}
            {{ /if }}
            
            // Remove duplicates and empty values
            this.slides = [...new Set(slides.filter(Boolean))];
        }
    }"
    x-init="initSlides()"
>
    <div class="lg:flex lg:gap-x-8 lg:mt-10 lg:items-start" x-show="slides.length">
        <div class="lg:w-2/3 lg:h-[500px]">
            <div class="h-full w-full overflow-hidden rounded-2xl cursor-pointer">
                <img
                    x-show="slides.length"
                    :src="slides[0]"
                    class="object-cover w-full h-full"
                    :alt="'{{ title }}'"
                    loading="lazy"
                    @click="openAt(0)"
                    @error="handleImageError($event)"
                >
            </div>
        </div>

        <div class="lg:w-1/3" x-show="slides.length > 1">
            <div class="relative flex flex-col gap-y-7 h-full">
                <template x-for="(slide, index) in slides" :key="'thumb-'+index">
                    <div
                        x-show="index > 0 && index < 3"
                        class="overflow-hidden max-h-[235px] flex-1 w-full rounded-2xl cursor-pointer"
                        @click="openAt(index)"
                    >
                        <img 
                            :src="slide" 
                            class="object-cover w-full h-full" 
                            loading="lazy" 
                            :alt="'{{ title }} thumbnail ' + index"
                            @error="handleImageError($event)"
                        >
                    </div>
                </template>

                {{ partial:partials/lightbox_slider }}
            </div>
        </div>
    </div>

    <div x-cloak x-show="isMobile && slides.length" class="splide mt-8" id="property-carousel">
        <div class="splide__track">
            <div class="splide__list">
                <template x-for="(slide, index) in slides" :key="'mobile-slide-'+index">
                    <div class="splide__slide">
                        <div class="max-h-[275px] h-full mt-8 overflow-hidden lg:mt-10 shrink-0 rounded-2xl">
                            <img 
                                :src="slide" 
                                class="object-cover w-full h-full" 
                                loading="lazy" 
                                :alt="'{{ title }} mobile ' + index" 
                                @click="openAt(index)"
                                @error="handleImageError($event)"
                            >
                        </div>
                        <div class="absolute px-3 py-1 text-sm font-medium text-white bg-black/50 rounded-2xl bottom-4 right-4">
                            <span x-text="index + 1"></span>
                            <span>/</span>
                            <span x-text="slides.length"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
